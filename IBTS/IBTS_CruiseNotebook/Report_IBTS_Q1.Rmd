---
title: |
  ![](HI logo farger engelsk.jpg){width=1in}  
  International Bottom Trawl Survey of the North Sea 2020 \n R/V G.O. Sars
author: 'Report generated by: Erik Olsen'
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  html_document:
    df_print: paged
    toc: yes
    toc_depth: '3'
  pdf_document:
    extra_dependencies: flafter
    toc: yes
    toc_depth: 3
classoption: landscape
---
\fontsize{12}{18}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 220, dev = "CairoPNG")
```

```{r, echo=FALSE, message=FALSE}
#Load required packages
Packages <- c("plyr","tidyverse", "data.table", "XML", "reshape2", 
              "chron", "proj4", "readxl", "readODS", "Cairo", "bookdown", "maps", "mapdata")
invisible(lapply(X = Packages,FUN = library, character.only = TRUE))
```

\pagebreak

# Cruise tracks and stations
## Predefined IBTS squares for sampling by the Norwegian vessel
The map below shows the northern region of the North Sea with ICES IBTS squares. The coloured squares are the ones that were planned to be sampled by the R/V G.O. Sars during the 2020 IBTS survey. 



```{r IBTS squares and survey plan, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width= "75%", fig.align="center"}

europe <- map_data("worldHires", c("Norway", "Sweden", "Denmark", "UK", "Germany")) 

#setting up grid
xvals <- seq(-4.5, 15.5, by=1)
yvals <- seq(55.25, 63, by=0.5)
ns_grid <- expand.grid(x=xvals,y=yvals)
write_csv2(ns_grid,"ns_grid.csv")

#editing the ns_grid.csv in excel adding square numbers and Norwegian Sampling scheme before exporting as a .csv file
ns_squares <- read.csv2("NSsquares.csv")

#creating map
gg <- ggplot(ns_squares, aes(x=Long, y=Lat, fill=as.factor(NOR_Squares))) + geom_tile(colour="gray40") + scale_fill_manual(values = c("NA", "lightskyblue2", "palevioletred2")) + guides(fill = guide_legend("Number of NOR \nstations pr square \n(1=1GOV+2MIK \n 2=2GOV+4MIK)")) +theme_minimal() + geom_map(data=europe, map=europe,  aes(x=long, y=lat, map_id=region), color="gray50", fill="gray60") + coord_map(xlim = c(-4, 12), ylim=c(55, 63)) + geom_rect(xmin=11,xmax=12,ymin=55,ymax=63, fill="white") + geom_rect(xmin=-4,xmax=12,ymin=62.5,ymax=63, fill="white") + annotate("text", label = c("39", "40", "41","42","43","44","45","46","47","48","49","50","51","52"), x = 11.5, y = seq(from = 55.25, to = 62, by = 0.5), size = 3) + annotate("text", label = c("E6", "E7", "E8","E9","F0","F1","F2","F3","F4","F5","F6","F7","F8","F9", "G0"), x = seq(from = -3.5, to = 10.5, by = 1), y = 62.75, size = 3)

gg 
ggsave("IBTSmap2020.png")

```


## Cruise track
Cruise tracks from the position log with points indicating start positions for different sampling gear. The points are jittered slightly for better visual representation:

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=5, out.width= "75%", fig.align="center"}

# Get bathymetry data from file
bath1<-read_csv(file = "Data/GeoData/ETOPO1_nm4.csv")

# Define map extent and depth contours
Ylim<-c(55,63)        #latitude
Xlim<-c(-4, 12)         #longitude
d.contours<-c(-100, -300,-500)   #Depth contours for plot with bathymetry

#reduce the resolution of depth contours (to increase speed when writing to file)
bath<-subset(bath1, bath1$y>(Ylim[1]-2) & (bath1$y<Ylim[2]+2) & bath1$ x>(Xlim[1]-2)& bath1$x<(Xlim[2]+2) & bath1$z<=(d.contours[1]+1500) & bath1$z>=(d.contours[length(d.contours)]-1500))

#create a list of the position files from the target directory
file_list <- list.files(path="Data/Track", pattern = ".csv")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
dataset <- data.frame()

#set temporary working directory
#setwd("Data/Track")

for (i in 1:length(file_list)){
  temp_data <- fread(paste("./Data/Track/",file_list[i], sep=""), stringsAsFactors = F,header = T, skip = 2,fill = T,strip.white = FALSE) #read in files using the fread function from the data.table package
  temp_data$Date <- strsplit(gsub(".csv", "", file_list[i]), "s")[[1]][2] #clean the data as needed, in this case I am creating a new column that indicates which date each file comes from
  #The latitude column is in format "DDMM.MMMM N"
  #The longitude column is in format "0DDMM.MMMM E"
  #Create new columns with lon and lat in decimal degrees
  temp_data <- temp_data %>% separate(Latitude, into = c("DD", "MM", "x1"), 
                                      sep = c(2,9), remove = F) %>% 
    separate(Longitude, into = c("x1.lon", "DD.lon", "MM.lon", "x2.lon"), 
             sep = c(1,3,12), remove = F)
  
  temp_data$EW <- substr(temp_data$Longitude, nchar(temp_data$Longitude) - 1 + 1, nchar(temp_data$Longitude)) 
  
  temp_data$DD <- as.numeric(temp_data$DD);temp_data$DD.lon <- as.numeric(temp_data$DD.lon)
  temp_data$MM <- as.numeric(temp_data$MM);temp_data$MM.lon <- as.numeric(temp_data$MM.lon)
  temp_data$Lat.dd <- temp_data$DD + temp_data$MM/60
  #modify Longitude according to E/W
  
  temp_data$EWF<-c(1)
  setDT(temp_data)[EW=="W", EWF:=-1]
  
  temp_data$Lon.dd <- (temp_data$DD.lon + temp_data$MM.lon/60)*temp_data$EWF
  
  dataset <- rbindlist(list(dataset, temp_data), use.names = T, fill = T) #for each iteration, bind the new data to the building dataset
  rm(temp_data)
  }

#Name the gears
dataset$gear.text <- NA
dataset$gear.text[dataset$`Station type` == "Bottom trawl start"] <- "Bottom trawl"
dataset$gear.text[dataset$`Station type` == "Pelagic trawl start" & dataset$Code %in% c("3513","3514")] <- "Pelagic trawl"
dataset$gear.text[dataset$Code == "3532" & dataset$`Station type` == "Pelagic trawl start"] <- "Trawling on registration"
dataset$gear.text[dataset$`Station type` == "CTD with watersample start"] <- "CTD"
dataset$gear.text[dataset$`Station type` == "Håv-trekk stasjon.start"] <- "WP2"
dataset$gear.text[dataset$`Station type` == "Mik. start"] <- "MIK"

#remove last two trawls - not part of official stations (sjøtest)
# dataset <- dataset %>% dplyr::filter(!Loc.St.No %in% c(624,625))

#Plot the cruise tracks and stations
g1 <- ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
  geom_point(data=dataset %>% dplyr::filter(is.na(gear.text)), aes(Lon.dd, Lat.dd, group = Date), alpha=0.25, colour="grey45", size=0.1, inherit.aes = F)+
  geom_jitter(data = dataset %>% dplyr::filter(!is.na(gear.text)), aes(Lon.dd, Lat.dd, color=gear.text), size = 2, shape = 6, inherit.aes = F, stroke = 0.75, width = 0.25)+
  scale_color_viridis_d(na.translate=F)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", color="Sampling gear")

g1 <- g1 + geom_tile(data=ns_squares, aes(x=Long, y=Lat), fill=NA, colour="gray40")
#g1
g1 + 
  annotate("text", label = c("39", "40", "41","42","43","44","45","46","47","48","49","50","51","52"), x = 11.5, y = seq(from = 55.25, to = 62, by = 0.5), size = 6)+ 
  annotate("text", label = c("E6", "E7", "E8","E9","F0","F1","F2","F3","F4","F5","F6","F7","F8","F9", "G0"), x = seq(from = -3.5, to = 10.5, by = 1), y = 62.75, size = 6)

```

\pagebreak
```{r, echo = FALSE, message=FALSE, results='hide', cache=TRUE}
#Specify the location of files in your working directory
test_schema <- "Data/Definitions/bioticv3.xsd"
biotic_files <- "Data/Biotic"

### Functions to get biotic data ()parsed from biotic xml-file v3, and functions to manipulate these data. 
### These functions are made by Edvin Fuglebakk
### The functions are used by code from line 400

keys_biotic3 <- list(MissionsType=c(), 
                     MissionType=c("missiontype", "missionnumber", "year", "platform"),
                     FishstationType=c("serialnumber"), 
                     CatchsampleType=c("catchsampleid"),
                     IndividualType=c("specimenid"),
                     AgedeterminationType=c(),
                     TagType=c(),
                     PreyType=c("preysampleid"),
                     PreylengthType=c(),
                     CopepodedevstageType=c()
)

foreign_keys_biotic3 <- list(MissionsType=c(), 
                             MissionType=c("missiontype", "missionnumber", "year", "platform"),
                             FishstationType=c("serialnumber"), 
                             CatchsampleType=c("catchsampleid"),
                             IndividualType=c("specimenid"),
                             AgedeterminationType=c(),
                             TagType=c(),
                             PreyType=c("preysampleid"),
                             PreylengthType=c(),
                             CopepodedevstageType=c()
)

hardcoded_schematype_function <- function(node){
  schematypes <- list(missions="MissionsType",
                      mission="MissionType",
                      fishstation="FishstationType",
                      catchsample="CatchsampleType",
                      individual="IndividualType",
                      agedetermination="AgedeterminationType",
                      tag="TagType",
                      prey="PreyType",
                      preylength="PreylengthType",
                      copepodedevstage="CopepodedevstageType"
  )
  return(schematypes[[xmlName(node)]])
}

dm <- list(KeyType="as.character", "CompositeTaxaKeyType"="as.character","CompositeTaxaSexKeyType"="as.character", "xs:integer"="as.integer", "xs:string"="as.character", "xs:decimal"="as.double", "key"="as.character", "xs:date"="as.Date", "xs:time"="as.character")
#'Set data types for bioticdata. 
#'Relies on the assumption that each tibble is named as the complexType in the xsd, excluding the suffix "Type"
#'Assumes fixed namespace prefix ns for http://www.w3.org/2001/XMLSchema
#'@param _parsed_data_ list of tibbles as returned by parse_biotic
#'@param schema XMLInternalDocument representing the xsd
#'@param datatype_mapping list mapping data types in schema to names of functions used to convert to R data types
#'@param keys list mapping schematypes to keys
#'@param foreign_keys list mapping schematypes to foreign keys
set_data_types <- function(bioticdata, schema, keys, foreign_keys, datatype_mapping=dm){
  get_data_types <- function(typename){
    s <- strsplit(typename, " ")[[1]]
    xmltypename <-  paste(toupper(substring(s, 1,1)), substring(s, 2),
                          sep="", collapse=" ")
    elements <- getNodeSet(schema, paste("/xs:schema/xs:complexType[@name='",xmltypename,"']//xs:element", sep=""), c(xs="http://www.w3.org/2001/XMLSchema"))
    attribs <- getNodeSet(schema, paste("/xs:schema/xs:complexType[@name='",xmltypename,"']//xs:attribute", sep=""), c(xs="http://www.w3.org/2001/XMLSchema"))
    fieldnames <- lapply(elements, xmlGetAttr, "name")
    fieldnames <- append(fieldnames, lapply(attribs, xmlGetAttr, "name"))
    fieldtypes <- lapply(elements, xmlGetAttr, "type")
    fieldtypes <- append(fieldtypes, lapply(attribs, xmlGetAttr, "type"))
    names(fieldtypes) <- fieldnames
    return(fieldtypes)
  }
  
  #convert data types
  for (fr in names(bioticdata)){
    typename <- paste(fr, "Type", sep="")
    dtypes <- get_data_types(typename)
    frame <- bioticdata[[fr]]
    for (coln in names(frame)){
      t<-dtypes[[coln]]
      if (is.null(t)){
        #deal with type of keys
        t <- "key"
      }
      ff <- datatype_mapping[[t]]
      
      if (is.null(ff)){
        stop(paste("Data type", t, "not mapped"))
      }
      frame[[coln]] <- eval(call(ff, frame[[coln]]))
    }
    bioticdata[[fr]] <- frame
  }
  
  #Fix key types
  add_key_types <- function(data, typename){
    p_keys <- keys[[typename]]
    if (is.null(p_keys)){
      return(data)
    }
    f_keys <- foreign_keys[[typename]]
    types <- get_data_types(typename)
    for (fr in names(data)){
      frame <- data[[fr]]
      for (i in 1:length(p_keys)){
        k <- p_keys[[i]]
        fk <- f_keys[[i]]
        if (fk %in% names(frame)){
          t<-types[[k]]
          if (is.null(t)){
            stop()
          }
          ff<-datatype_mapping[[t]]
          if (is.null(ff)){
            stop()
          }
          frame[[fk]] <- eval(call(ff, frame[[fk]]))
        }
      }
      data[[fr]] <- frame
    }
    return(data)
  }
  for (tn in names(keys)){
    bioticdata <- add_key_types(bioticdata, tn)
  }
  return(bioticdata)
}

#' Makes a list mapping foreign key names to their values, for the arument nodes and for all parent nodes up til root or <missions/>
#' @param node node The foreign key will reference
#' @param keys_table list mapping schematypes to keys
#' @param foreign_keys_table list mapping schematypes to foreign keys
#' @param schematype_function function mapping node names to their schematype
#' @return list with names <node name>.<key attribute> and values the value of the <key attribute> for this node
make_foreign_keys <- function(node, keys_table, foreign_keys_table, schematype_function){
  if (is.null(node)){
    return(list())
  }
  schematype <- schematype_function(node)
  if (is.null(schematype)){
    return(list())
  }
  foreign_keys <- list()
  
  if (schematype!="MissionType"){
    foreign_keys <- append(make_foreign_keys(xmlParent(node), keys_table, foreign_keys_table, schematype_function), foreign_keys)
  }
  if (length(keys_table[[schematype]])==0){
    return(foreign_keys)
  }
  for (i in 1:length(keys_table[[schematype]])){
    k <- keys_table[[schematype]][[i]]
    fk <- foreign_keys_table[[schematype]][[i]]
    foreign_keys[fk] <- xmlGetAttr(node, k)
  }
  return(foreign_keys)
}

#' Sets all blank entries in data frames to NA.
#' @param dataframes named list of Tibbles
#' @return named list of tibbles where all occurances of "" is set to NA.
set_blanks_to_NA <- function(dataframes){
  d <- dataframes
  for (n in names(d)){
    frame <- d[[n]]
    for (cn in names(frame)){
      frame[!is.na(frame[,cn]) & frame[,cn]=="",cn] <-NA
    }
    d[[n]]<-frame
  }
  return(d)
}

parsed_data_ <- list()
#creates handler for parsing specific xml elements
make_data_frame_parser <- function(framename, foreign_key_generator, drop=c(), verbose=F){
  parsed_data_[[framename]] <<- list()
  num=1
  parser <- function(node){
    nlist <- xmlApply(node, xmlValue)
    nlist[which(names(nlist) %in% drop)]<-NULL
    nlist <- append(foreign_key_generator(xmlParent(node)), nlist)
    nlist <- append(nlist, as.list(xmlAttrs(node)))
    parsed_data_[[framename]][[num]] <<- nlist
    num <<- num + 1
    return(NULL)
  }
  verbose_parser <- function(node){
    cat("Parsing:", xmlName(node), " ", xmlAttrs(node), "\n")
    return(parser(node))
  }
  if (verbose){
    return(verbose_parser)
  }
  else{
    return(parser)
  }
}

foreing_key_generator_3 <- function(node){return(make_foreign_keys(node, keys_biotic3, foreign_keys_biotic3, hardcoded_schematype_function))}
biotic_3_handlers <- list(
  #<text/> is added to drop, because xmlInternalTreeParse(trim=T) does not handle \n
  #missions=make_data_frame_parser("Missions", foreing_key_generator_1_4, c("mission", "text")),
  mission=make_data_frame_parser("mission", foreing_key_generator_3, c("fishstation", "text"), T),
  fishstation=make_data_frame_parser("fishstation", foreing_key_generator_3, c("catchsample", "text"), T), 
  catchsample=make_data_frame_parser("catchsample", foreing_key_generator_3, c("prey", "individual", "text")),
  individual=make_data_frame_parser("individual", foreing_key_generator_3, c("agedetermination", "tag", "text")),
  prey=make_data_frame_parser("prey", foreing_key_generator_3, c("preylength", "copepodedevstage", "text")),
  tag=make_data_frame_parser("tag", foreing_key_generator_3, c("text")),
  agedetermination=make_data_frame_parser("agedetermination", foreing_key_generator_3, c("text")),
  preylength=make_data_frame_parser("preylength", foreing_key_generator_3, c("text")),
  copepodedevstage=make_data_frame_parser("copepodedevstage", foreing_key_generator_3, c("text"))
)

#' Changes column names so that it is suffix by the name of the data frame it belongs to. 
#' Use before merging to ease trace to documentation.
#' Only column names that does not already contain a dot (".") will be changed.
#' @param _parsed_data_ a named list of data frames as returned by parse_biotic.
add_suffixes <- function(data){
  for (n in names(data)){
    if (!is.null(data[[n]]) & ncol(data[[n]])>0){
      cn <- colnames(data[[n]])
      for (i in 1:length(cn)){
        if (!grepl(".", cn[[i]], fixed=T)){
          cn[[i]] <- paste(cn[[i]], n, sep=".")
        }
      }
      
      colnames(data[[n]]) <- cn
    }
  }
  return(data)
}

#' Merges data into one flat Tibble, with records from higher levels in hierarchy repeated.
#' @param list of Tibbles as returned from parse_biotic
#' @return Tibble with merged data.
#' @details 
#' Assumes hierarchy is preserved, that is: No fishstations can be present if not mission present and so forth..
#' Otherwise only assumes presence of key and foreign key columns, so columns may be dropped before flattening.
#' All key columns are assumed to be named the same acrossdata frames and to be unqiuely named within a dataframe
#' @usage
#' e.g. flatten(parsebiotic(test_refl_2015, lift_names=T))
flatten <- function(bioticdata, keys=keys_biotic3, foreign_keys=foreign_keys_biotic3) {
  require(tibble) # dplyr joins are slow for chars, for some reason. Use merge and cast
  flat <- bioticdata$mission
  
  merge_into_flat <- function(tab){
    if (!is.null(tab) && nrow(tab)>0) {
      flat <- 
        merge(
          flat,
          tab,
          all.x=T
        )[,union(names(flat), names(tab))]
      flat <<- as_tibble(flat)
    }
  }
  merge_into_flat(bioticdata$fishstation)
  merge_into_flat(bioticdata$catchsample)
  merge_into_flat(bioticdata$individual)
  merge_into_flat(bioticdata$prey)
  merge_into_flat(bioticdata$agedetermination)
  merge_into_flat(bioticdata$tag)
  merge_into_flat(bioticdata$preylength)
  merge_into_flat(bioticdata$copepodedevstage)
  
  return(flat)
}

#
# Pre-allocates space for lists in parsed_data_
#
allocate_space <- function(xmlfile, handlers){
  doc <- xmlParse(xmlfile)
  ns = "m"
  for (n in names(handlers)){
    path <- paste("//",ns,":",n, sep="")
    total <- length(getNodeSet(doc, path, ns))
    parsed_data_[[n]]<<-vector("list",total)
  }
}

#
# Functions for parsing and data handling.
#

#' Parses biotic XML to relational data frames / Tibbles, with foreign keys.
#' @param xmlfile String : path to xml file to be parsed
#' @param handlers list of handlers determining which table to parse and which version of biotic is parsed. Default: all and 1.4.
#' @param set_data_types logical: Indicate if data types should be set for columns. If False all datatypes will be character.
#' @param schema path to schemafile used for setting datatypes. Only used if set_data_types=T
#' @param lift_names logical: If true all columns are renamed with <name>.<data frame>, whenever they do not already have a dot (".") in their name.
#' @return named list of data frames / Tibbles, one for each complex type in xml.
#' @usage 
#' parse_biotic(xmlfile)
#' ## for default version and all data
#' 
#' parse_biotic(xmlfile, handlers=biotic_3_handlers[c("mission", "fishstation")])
#' ## for parsing only tables mission and fishstation with version 3
#' @details 
#' Note that each column derives its name from the xml format. For documentation for Fishstation$serialno, see the documentation for 
#' the element serialno in FishstationType in the XML format.
#' Foreign keys derives their documentation from the corresponding primary key and are named according to the convention <target table>.<primary key>.
#' For instance the data frame / Tibble Catchsample has a column Fishstation.serialno.
#' The first columns in each frame / Tibble are the foreign keys.
#' 
#' lift_names makes foreing keys named the same as the corresponsing primary keys in other tables if 1.4 handlers are used for parsing.
#' For example, the column missiontype in Table Mission, will be renamed to missiontype.Mission, which is the same as the corresponding column is called on Fishstation.
#' This akes merging easier, and allows columns to be consistnetly named after merging. It also helps tracing the variable to xml format for documentation purposes.

parse_biotic <- function(xmlfile, handlers=biotic_3_handlers, set_data_types=F, schema=NULL, lift_names=F){
  if (!file.exists(xmlfile)){
    stop(paste("Can not find file:", xmlfile))
  }
  if (set_data_types & is.null(schema)){
    stop("Can not find schema for dataframe annotation.")
  }
  if (!set_data_types & !is.null(schema)){
    warning("Schemafile specified, but set_data_types is False.")
  }
  
  bpre <- parsed_data_
  allocate_space(xmlfile, handlers)
  xmlInternalTreeParse(xmlfile, handlers=handlers, ignoreBlanks=T, trim=T)
  d <- parsed_data_
  parsed_data_ <<- bpre
  
  for (n in names(d)){
    d[[n]]<-bind_rows(d[[n]])
  }
  
  d <- set_blanks_to_NA(d)
  if (set_data_types & !is.null(schema)){
    schema <- xmlParse(schema)
    d <- set_data_types(d, schema, keys=keys_biotic3, foreign_keys=foreign_keys_biotic3)
  }
  
  if (lift_names){
    d <- add_suffixes(d)
  }
  
  return(d)
}

#' Converts biotic xml file to a relational model and saves this in a set of csv files.
#' @param bioticxml character: path to XML file
#' @param target_dir character: path to directory where csv files will be written.
#' @param overwrite logical: specifies if existing csv files should be overwritten

convert_to_csv <- function(bioticxml, target_dir=".", overwrite=F){
  bioticdata <- parse_biotic(bioticxml, schema=NULL)
  for (n in names(bioticdata)){
    filename <- paste(target_dir, "/", n, ".csv", sep="")
    if (file.exists(filename) & !overwrite){
      print(paste("File:", filename, "exists."))
    }
    else{
      write.csv(bioticdata[n], file=filename)  
    }
  }
}

#' rbind all dataframes in frames1, with corresponding frames in frames2
#' Any frame sin frames2, not in frames 1 is ignored.
#' Columns only present in one of the paired frames will be padded with NA values in the concatenated frame.
#' Apart from this no consistency or uniqueness checks are made
#' @param frames1 named list of Tibbles
#' @param frames2 named list of Tibbles
#' @return named list of Tibbles, one for each in frame1, with correspdonding frames in frames2 appended.
cat_dataframes <- function(frames1, frames2){
  dataframes <- frames1
  for (n in names(frames1)){
    if (!is.null(frames2[[n]])){
      dataframes[[n]] <- bind_rows(dataframes[[n]], frames2[[n]])      
    }
  }
  return(dataframes)
}

######### Read in data using the functions and plot ########

#biotic_files is the directory for biotic xml files (specified in the beginning)
tokt <- paste0(biotic_files,"/",list.files(path="Data/Biotic", pattern = ".xml"))

# Denne lagar tabellar for kvart nivå i biotic data

dd<- parse_biotic(tokt, handlers=biotic_3_handlers, set_data_types=T, schema = test_schema)

#Denne mergar saman stasjonsnivå og fangstnivå i dd-strukturen og legg til fangstratar

stasamp <- right_join(dd$fishstation,dd$catchsample) %>% mutate(cr.kg.nm=catchweight/distance) %>% mutate(cr.n.nm=catchcount/distance)

#Legg til geartype i tekstformat
stasamp$gear.text <- "Bottom trawl"
stasamp$gear.text[stasamp$gear %in% c("3513", "3514")] <- "Pelagic trawl"
```
# Sampling depth for trawl hauls  

`r length(unique(stasamp$station))` bottom trawl hauls were taken during the survey. The trawl hauls covered a total distance of `r round((sum(dd$fishstation$distance)*1852)/1000, digits = 1)` km (`r round((sum(dd$fishstation$distance)), digits = 1)` nmi).  
  
The sampling stations were located in areas with bottom depths from `r round(min((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits =1)` m to `r round(max((stasamp$bottomdepthstart+stasamp$bottomdepthstop)/2), digits = 1)` m, and the fishing depth varied from `r round(min((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)` m to `r round(max((stasamp$fishingdepthmin+stasamp$fishingdepthmax)/2), digits=1)` m.


## Mean fishing depth during trawl hauls 
```{r, echo=FALSE, message=FALSE, fig.width=6, fig.height=3, out.width= "65%"}
## Depth at sampled stations - fish
stdat <- dd$fishstation

stdat$gear.text <- "Bottom trawl"
stdat$gear.text[stdat$gear %in% c("3513", "3514")] <- "Pelagic trawl"

#Fishing depth
ggplot(stdat %>% dplyr::filter(!gear.text == "Pelagic trawl"), aes((fishingdepthmin+fishingdepthmax)/2, fill = gear.text))+
  geom_histogram(color="black")+
  labs(x= "Mean fishing depth during trawl haul (m)", y = "Number")+
  scale_fill_viridis_d(name = "Gear")+theme_bw()
```

\pagebreak

# Catch rates - biomass and number per nautical mile trawled for species registered in Sea2Data

## Species diversity

```{r,echo=FALSE, message=FALSE}
#Sjekk hvilke arter som er vanligst
tst<-stasamp %>% dplyr::group_by(scientificname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))
```

A total of `r length(unique(tst$scientificname))` species were registered in Sea2Data during the survey.

### Number of species identified versus the number of stations sampled

```{r, echo = FALSE, message=FALSE, fig.width=3, fig.height=3, out.width= "35%"}
#cumulative number of species vs number of stations

nspec <- data.frame(station=unique(stasamp$station),
           nspecies=tapply(cumsum(!duplicated(stasamp$scientificname)), stasamp$station,max))

nspec$nstation <- seq(1:nrow(nspec))

ggplot(nspec, aes(nstation, nspecies))+geom_line(size = 1)+theme_bw()+
  labs(x = "Number of stations sampled", y = "Number of unique species identified")
```

\pagebreak

## Average catch rate by species for the 20 species with highest catch rates

### Bottom trawl
```{r,echo=FALSE, message=FALSE, fig.width=9, fig.height=3.3, out.width= "85%", fig.align="center", warning=FALSE}
#exclude stations with gear_condition = 2 (torn trawl)
tst<-subset(stasamp, gearcondition==1) %>% dplyr::group_by(gear.text,commonname) %>% 
  dplyr::summarise(meanW=mean(cr.kg.nm), meanN = mean(cr.n.nm),
                   minW = min(cr.kg.nm), maxW = max(cr.kg.nm),
                   minN = min(cr.n.nm), maxN = max(cr.n.nm))

gear <- "Bottom trawl"

#Weight
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(commonname)),
       aes(reorder(commonname, -meanW), meanW))+geom_col()+
  # geom_errorbar(aes(ymin = minW, ymax = maxW))+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$meanW[tst$gear.text==gear], na.rm=T)+20))+theme_bw()+
  theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11),
        axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Mean catch rate (kg/nmi)", title = "Biomass")

#Number
ggplot(tst %>% dplyr::filter(gear.text == gear & !is.na(commonname)),
       aes(reorder(commonname, -meanN), meanN))+geom_col()+
  # geom_errorbar(aes(ymin = minN, ymax = maxN))+
  coord_cartesian(xlim =c(1,20))+ #show the 20 species with highest catches
  scale_y_continuous(expand=c(0,0), limits = c(0,max(tst$meanN[tst$gear.text==gear], na.rm=T)+100))+#, limits = c(0,700))+
  theme_bw()+theme(axis.text.x = element_text(angle = 35, colour = "red", size = 11), axis.title.x = element_blank())+
  labs(x = "Taxon", y = "Mean catch rate (N/nmi)", title = "Number of individuals")

```

## Spatial variation in catches of common species

### Pelagic fish

### Herring

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Clupea harengus" #for species caught in 2 out of 3 gears (figure size is adjusted)

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Sprat

```{r, eval=FALSE, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Sprattus sprattus"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Mackerel

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Scomber scombrus"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```


### Demersal fish

### Haddock

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Melanogrammus aeglefinus"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Cod

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Gadus morhua"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Whiting

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Merlangius merlangus"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Norway pout

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Trisopterus esmarkii"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Saithe

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Pollachius virens"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Hake

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Merluccius merluccius"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```

### Blackbelly rosefish (Blåkjeft)

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, warning=FALSE, out.width="90%", fig.align="center"}
Title.on<-1            #1 for showing chart title, 0 for not showing it
Bubble.size<-6        #Max size of bubbles in bubble plots
Yr <- c(2020)

#coordinates for ship track
coord.track <- dataset %>% dplyr::select(Date,Log, Lon.dd, Lat.dd) %>% data.frame()

species <- "Helicolenus dactylopterus"

Title=ifelse(Title.on==1,paste("Biomass","|",toString(Yr),"|",toString(species)),"")

#Catch rate kg/nmi 
ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),aes(longitudestart,latitudestart,size = cr.kg.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
    facet_grid(~gear.text)+
 # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (kg/nmi)", title=Title)

#number catches
Title=ifelse(Title.on==1,paste("Number of individuals","|",toString(Yr),"|",toString(species)),"")

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) + 
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey65", size=0.1, inherit.aes = F)+
  geom_point(data=stasamp %>% dplyr::filter(scientificname == species),
             aes(longitudestart,latitudestart,size = cr.n.nm),
             shape=21, alpha = 0.7, colour = "black",fill = "orange", stroke = .2)+
  facet_grid(~gear.text)+
  # geom_path(data=stasamp.map,aes(longitudestart,latitudestart), linejoin="round",lineend="square",alpha=0.4,colour="black",size=0.4)+
  scale_size_area(max_size=Bubble.size)+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = NULL, y = NULL, size = "Catch rate (N/nmi)", title=Title)
```




## Length distributions

The following figures shows the length distribution of individuals sampled during the survey.

```{r, echo=FALSE, message=FALSE, fig.width=8, fig.height=5.5, out.width= "80%", warning=FALSE}
stasampindi <- right_join(stasamp,dd$individual)
stasampindiage <- left_join(stasampindi, dd$agedetermination)

#Kg -> g and m -> cm
stasampindiage$weight.g <- (stasampindiage$individualweight * 1000 )
stasampindiage$length.cm <- (stasampindiage$length * 100 )

#Subset the data depending on measurement precision (largely demersal/pelagic species)
#REF5cm <- subset(stasampindiage, commonname %in% c('torsk', "hyse", "snabeluer", "vanlig uer", "lusuer"))
#REF1cm <- subset(stasampindiage, commonname %in% c('lodde', "polartorsk", "sild'G03", "kolmule"))

#ggplot(data=REF5cm, aes(x=length.cm)) + geom_histogram(breaks=seq(0, 75, by=2), col="black", fill="steelblue", alpha = .6, stroke = 0.25)  + labs(title="Histogram of length", x="Length (cm)", y="Count") + facet_wrap(~scientificname, scales="free")+theme_bw()


# all species caught
ggplot(subset(stasampindiage, individualweight>0), aes(x=length.cm, y=individualweight, group=commonname)) +geom_point(size=3, shape="+", aes(colour=commonname)) + guides(colour=FALSE) + facet_wrap(~commonname, scales="free") + theme_grey() + labs(x="Lengde (cm)", y="Vekt (g)") +theme_bw()

```

\pagebreak

## Length-age relationships

```{r, echo=FALSE, message=FALSE, fig.width=8, fig.height=5, out.width= "80%", warning=FALSE}
ggplot(subset(stasampindiage, age>0), aes(length.cm, age))+geom_point(size = 0.5)+facet_wrap(~scientificname, scales = "free")+
  theme_bw()+labs(x = "Length (cm)", y = "Age (years)")



```

\pagebreak

# CTD
```{r, echo=FALSE, message=FALSE}
getwd()
#create a list of the files from your target directory
file_list <- list.files(path="Data/CTD",  pattern = ".cnv")

#set temporary working directory
setwd("Data/CTD")

#initiate a blank data frame, each iteration of the loop will append the data from the given file to this variable
ctd <- data.frame()

for (i in 1:length(file_list)){
  temp_data <- fread(file_list[i], stringsAsFactors = F,header = F, skip = 340) #read in files using the fread function from the data.table package
  names(temp_data) <- c("scan_count", "pressure_db", "temperature", "temperature_2", 
                   "conductivity", "conductivity_2", "oxygen_raw", "altimeter", "fluorescence",                    "par_irradiance", "surface_irradiance", "time_sec", "days_julian",
                   "oxygen_ml_l", "salinity_PSU", "salinity_2", "density", "sound_velocity", 
                   "sound_velocity_av", "flag")
  #select the measurements from when the CTD was descending
  temp_data <- temp_data[1:ceiling(nrow(temp_data)/2),]
  #Create a station variable from the file name
  temp_data$station <- strsplit(gsub(".cnv", "", file_list[i]), "sta")[[1]][2] 
  ctd <- rbindlist(list(ctd, temp_data), use.names = T) #for each iteration, bind the new data to the building dataset
  rm(temp_data)
}

##position of stations is in data.frame called dataset from the cruise log

ctdpos <- dataset %>% dplyr::select(Loc.St.No,Time,Date, Lon.dd, Lat.dd) %>% 
  dplyr::rename(station = Loc.St.No) %>% dplyr::filter(!is.na(station)) %>% 
  dplyr::arrange(station) %>% data.frame()
ctdpos$station <- as.character(ctdpos$station) 
ctdpos <- ctdpos %>% dplyr::group_by(station) %>% 
  dplyr::summarise(Lon = mean(Lon.dd),Lat = mean(Lat.dd), Time = unique(Time)[1], 
                   Date = unique(Date)[1])
for(i in 1:length(ctdpos$station)){
 while(nchar(ctdpos$station[i])<4){
  ctdpos$station[i] <- paste0("0",ctdpos$station[i])
 }
}

ctd <- left_join(ctd, ctdpos)

maxdepth <- ctd %>% dplyr::group_by(station, Lon, Lat) %>% 
  dplyr::summarise(max_depth = max(pressure_db))
ctd <- left_join(ctd, maxdepth)
ctd$plotdepth <- NA
ctd$plotdepth[ctd$pressure_db<=50] <- "Surface"
ctd$plotdepth[ctd$max_depth-ctd$pressure_db<=50] <- "Bottom"

#If the depth is <= 50 m, the surface layer will be overwritten by the bottom layer in the command above. Therefore add an extra line with the same temperature for surface.
for(i in 1:nrow(ctd)){
  if(ctd$max_depth[i]<=51){
    extra <- ctd[i,]
    extra$plotdepth <- "Surface"
    ctd <- rbind(ctd, extra)
  }}

ctd.plot <- ctd %>% dplyr::group_by(station, Lon, Lat, Date, Time, plotdepth, max_depth) %>% 
  dplyr::summarise(mean_temp = mean(temperature), mean_salinity = mean(salinity_PSU)) %>% dplyr::filter(!is.na(plotdepth)) %>% 
  data.frame()

```
## Summary of measurements

`r length(unique(ctd$station))` CTD casts were done during the survey, covering a total depth of `r round(sum(maxdepth$max_depth)/1000, digits = 1)` km.

```{r, echo=FALSE, fig.height=3, fig.width=4.5, out.width= "40%",fig.show="hold", message=FALSE, warning=FALSE}

ggplot(ctd, aes(temperature))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Temperature (deg C)", y = "Count")

ggplot(ctd, aes(salinity_PSU))+geom_histogram(color="black")+theme_bw()+
  labs(x = "Salinity (PSU)", y = "Count")
```

\pagebreak

## Variation in temperature and salinity with bathymetry and geographical location

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "85%", warning=FALSE, fig.align="center"}

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
  geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_temp), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="RdYlBu")+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean temperature
(deg C)")
```

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=3, out.width= "85%", warning=FALSE, fig.align="center"}

ggplot(bath, aes(x=x, y=y))+
  geom_contour(aes(z=z), breaks=d.contours,colour="lightblue", size=0.5,show.legend = TRUE)+ 
  geom_contour(aes(z=z), breaks=c(0,1),color="darkgrey", size=.6) +
 geom_point(data=coord.track, aes(Lon.dd, Lat.dd, group = Date), alpha=0.1, colour="grey45", size=0.1, inherit.aes = F)+
  geom_point(data=ctd.plot, aes(Lon, Lat, fill = mean_salinity), size = 2, color="black", shape = 21)+
  facet_wrap(~plotdepth)+
  scale_fill_distiller(palette="BuPu", trans = "reverse", guide = guide_colorbar(reverse = T))+
  theme_bw()+
  coord_map(xlim = Xlim,ylim = Ylim)+
  labs(x = "Longitude", y = "Latitude", fill="Mean salinity (PSU)")
```

\pagebreak
## Density in the water column

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=2.8, warning=FALSE, fig.align="center"}

depthlim <- 100 #choose the maximum depth you want to plot

ggplot(ctd, aes(density, pressure_db, group=station, color=Lat))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color="Latitude (N)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
                   panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())

ggplot(ctd, aes(density, pressure_db, group=station, color=Lon))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("Density (sigma-t, kg/"*m^3*")"), 
       y = "Depth (m)", color="Longitude (E)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
                   panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
                   panel.grid.minor = element_blank())
```

\pagebreak
## Light in the water column

```{r, echo=FALSE, message=FALSE, fig.width=9, fig.height=4, warning=FALSE, fig.align="center"}

tst <- strptime(ctd$Time, format = "%H:%M:%S")
tt1 <- chron::times(format(tst, "%H:%M:%S"))
ctd$timetest <- tt1

ctd$newtime <- hours(ctd$timetest)

ggplot(ctd, aes(par_irradiance, pressure_db, group=station, color=newtime))+
  geom_line(size = 0.55)+
  scale_y_reverse(limits=c(depthlim,0))+
  scale_color_distiller(palette="Spectral")+
  # scale_color_viridis_c(option = "A")+
  labs(x = expression("PAR irradiance ("*mu*"E/"*m^2*"s"*")"), 
       y = "Depth (m)", color="Time of day (h)")+
  theme_bw()+theme(panel.background = element_rect(fill="black"),
        panel.grid.major = element_line(color = "grey45", size = 0.1, linetype=1),
        panel.grid.minor = element_blank())

```
